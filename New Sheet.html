<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Google Sheet WDC</title>
  <script src="https://connectors.tableau.com/libs/tableauwdc-2.3.latest.js"></script>
  <script>
    (function () {
      var myConnector = tableau.makeConnector();

      // Define schema dynamically from headers
      myConnector.getSchema = function (schemaCallback) {
        var csvUrl = "https://docs.google.com/spreadsheets/d/1WnpMgmStDvq5EqTcEbD3DEkb-QljC0xuHt1LZ4Vwplo/export?format=csv&gid=0";

        fetch(csvUrl)
          .then(response => response.text())
          .then(csvText => {
            var rows = tableau.helpers.parseCsv(csvText);

            // Take headers from first row
            var headers = Object.keys(rows[0]);
            var cols = headers.map(h => ({
              id: h.trim(),
              alias: h.trim(),
              dataType: tableau.dataTypeEnum.string   // default string
            }));

            var tableSchema = {
              id: "googleSheetData",
              alias: "Google Sheet Data",
              columns: cols
            };

            schemaCallback([tableSchema]);
          })
          .catch(err => console.error("Schema fetch error:", err));
      };

      // Pull the data
      myConnector.getData = function (table, doneCallback) {
        var csvUrl = "https://docs.google.com/spreadsheets/d/1WnpMgmStDvq5EqTcEbD3DEkb-QljC0xuHt1LZ4Vwplo/export?format=csv&gid=0";

        fetch(csvUrl)
          .then(response => response.text())
          .then(csvText => {
            var rows = tableau.helpers.parseCsv(csvText);

            // Push everything as-is
            table.appendRows(rows);
            doneCallback();
          })
          .catch(err => {
            console.error("Error fetching Google Sheet:", err);
            doneCallback();
          });
      };

      tableau.registerConnector(myConnector);

      window.onload = function () {
        document.getElementById("submitButton").addEventListener("click", function () {
          tableau.connectionName = "Google Sheet Data (Auto)";
          tableau.submit();
        });
      };
    })();
  </script>
</head>
<body>
  <h2>Google Sheet WDC</h2>
  <button id="submitButton">Load Data into Tableau</button>
</body>
</html>
