<!DOCTYPE html>
<html>
<head>
  <title>Google Sheets WDC</title>
  <script src="https://connectors.tableau.com/libs/tableauwdc-2.3.0.js"></script>
</head>
<body>
  <h2>Google Sheets Web Data Connector</h2>
  <p>This connector pulls data from a public Google Sheet.</p>
  <button id="submitButton">Get Data</button>

  <script>
    const sheetURL = "https://docs.google.com/spreadsheets/d/1ulbGb-UYEIp6VXJ7GyKkzS_DY5qrO_r57OOBO2CuxyA/gviz/tq?tqx=out:json";

    (function() {
      var myConnector = tableau.makeConnector();

      myConnector.getSchema = function(schemaCallback) {
        fetch(sheetURL)
          .then(res => res.text())
          .then(dataText => {
            const json = JSON.parse(dataText.substr(47).slice(0, -2)); // Trim Google Sheets response
            const cols = json.table.cols;

            const schema = {
              id: "googleSheetData",
              alias: "Google Sheet Data",
              columns: cols.map(col => ({
                id: col.label || col.id,
                alias: col.label || col.id,
                dataType: tableau.dataTypeEnum.string
              }))
            };

            schemaCallback([schema]);
          });
      };

      myConnector.getData = function(table, doneCallback) {
        fetch(sheetURL)
          .then(res => res.text())
          .then(dataText => {
            const json = JSON.parse(dataText.substr(47).slice(0, -2));
            const rows = json.table.rows;
            const cols = json.table.cols;

            const data = rows.map(row => {
              const rowObj = {};
              row.c.forEach((cell, idx) => {
                rowObj[cols[idx].label || cols[idx].id] = cell ? cell.v : null;
              });
              return rowObj;
            });

            table.appendRows(data);
            doneCallback();
          });
      };

      tableau.registerConnector(myConnector);

      document.getElementById("submitButton").addEventListener("click", function() {
        tableau.connectionName = "Google Sheet Connector";
        tableau.submit();
      });
    })();
  </script>
</body>
</html>
