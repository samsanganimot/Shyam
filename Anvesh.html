<!DOCTYPE html>
<html>
<head>
  <title>Google Sheet Web Data Connector</title>
  <script src="https://connectors.tableau.com/libs/tableauwdc-2.3.0.js"></script>
</head>
<body>
  <h2>Google Sheet WDC</h2>
  <p>This connector fetches all rows and columns from the specified Google Sheet.</p>
  <button id="getDataButton">Load Data into Tableau</button>

  <script>
    // âœ… Your actual Google Sheet JSON export URL
    const sheetURL = "https://docs.google.com/spreadsheets/d/1ulbGb-UYEIp6VXJ7GyKkzS_DY5qrO_r57OOBO2CuxyA/gviz/tq?tqx=out:json";

    (function () {
      var myConnector = tableau.makeConnector();

      myConnector.getSchema = function (schemaCallback) {
        fetch(sheetURL)
          .then(res => res.text())
          .then(rawText => {
            const json = JSON.parse(rawText.substr(47).slice(0, -2));
            const cols = json.table.cols;

            const columns = cols.map(col => {
              const rawLabel = col.label || `col_${col.id}`;
              const safeId = rawLabel.replace(/[^a-zA-Z0-9_]/g, '_'); // ðŸ”§ Sanitize ID
              return {
                id: safeId,
                alias: rawLabel,
                dataType: tableau.dataTypeEnum.string
              };
            });

            schemaCallback([{
              id: "googleSheetData",
              alias: "Google Sheet Data",
              columns: columns
            }]);
          });
      };

      myConnector.getData = function (table, doneCallback) {
        fetch(sheetURL)
          .then(res => res.text())
          .then(rawText => {
            const json = JSON.parse(rawText.substr(47).slice(0, -2));
            const rows = json.table.rows;
            const cols = json.table.cols;

            const data = rows.map(row => {
              const rowObj = {};
              row.c.forEach((cell, idx) => {
                const rawLabel = cols[idx].label || `col_${cols[idx].id}`;
                const safeId = rawLabel.replace(/[^a-zA-Z0-9_]/g, '_'); // ðŸ”§ Sanitize ID
                rowObj[safeId] = cell ? cell.v : null;
              });
              return rowObj;
            });

            table.appendRows(data);
            doneCallback();
          });
      };

      tableau.registerConnector(myConnector);

      document.getElementById("getDataButton").addEventListener("click", () => {
        tableau.connectionName = "Google Sheet Data";
        tableau.submit();
      });
    })();
  </script>
</body>
</html>
