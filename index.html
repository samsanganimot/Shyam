<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Dynamic Google Sheet WDC</title>
    <script src="https://connectors.tableau.com/libs/tableauwdc-2.3.latest.js"></script>
    <script>
    (function() {
        var myConnector = tableau.makeConnector();
        var headers = []; // global store for column headers

        // Step 1: Build schema dynamically
        myConnector.getSchema = function(schemaCallback) {
            var csvUrl = "https://docs.google.com/spreadsheets/d/1rBfgPGQr-oRj8biMzj1wxynRLCeHILdwFR5E9_K8gbk/export?format=csv&gid=0";

            fetch(csvUrl)
                .then(response => response.text())
                .then(csvText => {
                    var data = tableau.helpers.parseCsv(csvText);
                    console.log("Parsed data for schema:", data);

                    if (data.length === 0) {
                        throw new Error("No rows found in Google Sheet");
                    }

                    // Detect headers from first row
                    headers = Object.keys(data[0]);

                    var cols = headers.map(h => ({
                        id: h.replace(/\s+/g, "_"), // replace spaces with underscores
                        alias: h,
                        dataType: tableau.dataTypeEnum.string
                    }));

                    var tableSchema = {
                        id: "googleSheetFeed",
                        alias: "Google Sheet Data",
                        columns: cols
                    };

                    schemaCallback([tableSchema]);
                })
                .catch(err => {
                    console.error("Error building schema:", err);
                });
        };

        // Step 2: Load data dynamically
        myConnector.getData = function(table, doneCallback) {
            var csvUrl = "https://docs.google.com/spreadsheets/d/1rBfgPGQr-oRj8biMzj1wxynRLCeHILdwFR5E9_K8gbk/export?format=csv&gid=0";

            fetch(csvUrl)
                .then(response => response.text())
                .then(csvText => {
                    var data = tableau.helpers.parseCsv(csvText);
                    console.log("Parsed data for rows:", data);

                    var rows = data.map(row => {
                        var obj = {};
                        headers.forEach(h => {
                            obj[h.replace(/\s+/g, "_")] = row[h] || "";
                        });
                        return obj;
                    });

                    table.appendRows(rows);
                    doneCallback();
                })
                .catch(err => {
                    console.error("Error fetching data:", err);
                    doneCallback();
