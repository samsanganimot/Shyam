<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Google Sheet WDC</title>
<script src="https://connectors.tableau.com/libs/tableauwdc-2.3.latest.js"></script>
<script>
(function() {
    var myConnector = tableau.makeConnector();

    // Step 1: Hard-coded schema (required for Tableau 2025.2.x)
    myConnector.getSchema = function(schemaCallback) {
        var cols = [
            { id: "category", alias: "category", dataType: tableau.dataTypeEnum.string },
            { id: "sub_category", alias: "sub category", dataType: tableau.dataTypeEnum.string },
            { id: "region", alias: "region", dataType: tableau.dataTypeEnum.string }
        ];

        var tableSchema = {
            id: "googleSheetFeed",
            alias: "Google Sheet Data",
            columns: cols
        };

        schemaCallback([tableSchema]);
    };

    // Step 2: Fetch and map data
    myConnector.getData = function(table, doneCallback) {
        var csvUrl = "https://docs.google.com/spreadsheets/d/1rBfgPGQr-oRj8biMzj1wxynRLCeHILdwFR5E9_K8gbk/export?format=csv&gid=0";

        fetch(csvUrl)
            .then(r => r.text())
            .then(csvText => {
                var rows = tableau.helpers.parseCsv(csvText);

                var mapped = rows.map(row => {
                    return {
                        category: row["category"] || "",
                        sub_category: row["sub category"] || "",
                        region: row["region"] || ""
                    };
                });

                table.appendRows(mapped);
                doneCallback();
            })
            .catch(err => {
                console.error("Error fetching data:", err);
                doneCallback();
            });
    };

    tableau.registerConnector(myConnector);

    // Step 3: Button click to submit
    window.onload = function() {
        document.getElementById("submitButton").addEventListener("click", function() {
            tableau.connectionName = "Google Sheet WDC";
            tableau.submit();
        });
    };
})();
</script>
</head>
<body>
<h2>Google Sheet WDC</h2>
<button id="submitButton">Load Data into Tableau</button>
</body>
</html>
