<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Google Sheet Dynamic WDC</title>
    <script src="https://connectors.tableau.com/libs/tableauwdc-2.3.latest.js"></script>
    <script>
    (function() {
        var myConnector = tableau.makeConnector();
        var headerMap = []; // maps sheet headers to Tableau column IDs

        // Step 1: Build schema dynamically
        myConnector.getSchema = function(schemaCallback) {
            var csvUrl = "https://docs.google.com/spreadsheets/d/1rBfgPGQr-oRj8biMzj1wxynRLCeHILdwFR5E9_K8gbk/export?format=csv&gid=0";

            fetch(csvUrl)
                .then(response => response.text())
                .then(csvText => {
                    var rows = tableau.helpers.parseCsv(csvText);

                    if (!rows || rows.length === 0) {
                        throw new Error("Google Sheet is empty");
                    }

                    var headers = Object.keys(rows[0]);
                    var cols = headers.map(h => {
                        var safeId = h.trim().replace(/\s+/g, "_");
                        headerMap.push({ sheet: h, tableau: safeId });
                        return {
                            id: safeId,
                            alias: h,
                            dataType: tableau.dataTypeEnum.string
                        };
                    });

                    var tableSchema = {
                        id: "googleSheetFeed",
                        alias: "Google Sheet Data",
                        columns: cols
                    };

                    schemaCallback([tableSchema]);
                })
                .catch(err => {
                    console.error("Schema fetch error:", err);
                    // Fallback schema so Tableau always gets something valid
                    schemaCallback([{
                        id: "googleSheetFeed",
                        alias: "Google Sheet Data (Fallback)",
                        columns: [
                            { id: "category", alias: "category", dataType: tableau.dataTypeEnum.string },
                            { id: "sub_category", alias: "sub category", dataType: tableau.dataTypeEnum.string },
                            { id: "region", alias: "region", dataType: tableau.dataTypeEnum.string }
                        ]
                    }]);
                });
        };

        // Step 2: Load data dynamically
        myConnector.getData = function(table, doneCallback) {
            var csvUrl = "https://docs.google.com/spreadsheets/d/1rBfgPGQr-oRj8biMzj1wxynRLCeHILdwFR5E9_K8gbk/export?format=csv&gid=0";

            fetch(csvUrl)
                .then(response => response.text())
                .then(csvText => {
                    var rows = tableau.helpers.parseCsv(csvText);

                    if (!rows || rows.length === 0) {
                        doneCallback();
                        return;
                    }

                    var mappedRows = rows.map(row => {
                        var obj = {};
                        headerMap.forEach(m => {
                            obj[m.tableau] = row[m.sheet] || "";
                        });
                        return obj;
                    });

                    table.appendRows(mappedRows);
                    doneCallback();
                })
                .catch(err => {
                    console.error("Data fetch error:", err);
                    doneCallback();
                });
        };

        tableau.registerConnector(myConnector);

        // Step 3: Button click to submit
        window.onload = function() {
            document.getElementById("submitButton").addEventListener("click", function() {
                tableau.connectionName = "Google Sheet Dynamic WDC";
                tableau.submit();
            });
        };
    })();
    </script>
</head>
<body>
    <h2>Google Sheet Dynamic WDC</h2>
    <button id="submitButton">Load Data into Tableau</button>
</body>
</html>
